<!DOCTYPE html>
<html lang="en">
<head>
<title>CSS Template</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
  box-sizing: border-box;
}
/* Dark mode via prefers-color-scheme */
@media (prefers-color-scheme: dark) {
    :root {
        --bg-color: #1c1c1c;
        --text-color: #eee;
        --nav-bg: rgba(26, 26, 26, 0.85);;
        --nav-border: rgba(255, 255, 255, 0.05);
        --nav-box: rgba(0, 0, 0, 0.5);
    }
}

/* Light mode via prefers-color-scheme */
@media (prefers-color-scheme: light) {
    :root {
        --bg-color: #e5e5e5;
        --text-color: #333;
        --nav-bg:rgba(255, 255, 255, 0.8);
        --nav-border: none;
        --nav-box: rgba(0, 0, 0, 0.08);
    }
}

body.light {
    --bg-color: #e5e5e5;
    --text-color: #333;
    --nav-bg:rgba(255, 255, 255, 0.8);
    --nav-border: none;
    --nav-box: rgba(0, 0, 0, 0.08);
}

body.dark {
    --bg-color: #1c1c1c;
    --text-color: #eee;
    --nav-bg: rgba(26, 26, 26, 0.85);;
    --nav-border: rgba(255, 255, 255, 0.05);
    --nav-box: rgba(0, 0, 0, 0.5);
}
html, body {
  height: 100%;
  margin: 0;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* Container for flexboxes */
.row {
  display: -webkit-flex;
  display: flex;
    flex: 1;
      margin-top: 10px;
}

/* Create three unequal columns that sits next to each other */
.column {
  padding: 10px;
  height: 100%;
}

/* Left and right column */
.column.side {
   -webkit-flex: 0 0 20%;
   -ms-flex: 0 0 20%;
    flex: 0 0 20%;
    width: 20%;
}

/* Middle column */
.column.middle {
  -webkit-flex: 0 0 60%;
  -ms-flex: 0 0 60%;
  flex: 0 0 60%;
  width: 60%;
}

/* Style the footer */
.footer {
  padding: 10px;
  text-align: center;
  height: 5%;
}

/* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
@media (max-width: 600px) {
  .row {
    -webkit-flex-direction: column;
    flex-direction: column;
  }
}
/* --- NAVBAR CONTAINER --- */
/* === HEADER NAVBAR === */
.header {
  width: 100%;
  position: sticky;
  top: 0;
  left: 0;
  height: 72px; /* you can change to 12px if really needed */
  backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.35);
  display: flex;
  align-items: center;
  z-index: 999;
}

/* Dark mode header transparency */
body.dark .header {
  background: rgba(0, 0, 0, 0.35);
}

/* === NAV LAYOUT === */
.nav-container {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center; /* centers links */
  padding: 0 1rem;
  position: relative;
}

/* === HAMBURGER === */
.hamburger {
  position: absolute;
  left: 1rem;
  background: none;
  border: none;
  cursor: pointer;
}

body.dark .hamburger {
  color: #eee;
}

/* === NAV MENU === */
.nav-menu {
  display: flex;
  justify-content: center;
  width: 100%;
}

/* === LINKS === */
.nav-links {
  list-style: none;
  display: flex;
  gap: 28px;
  padding: 0;
  margin: 0;
}

.nav-item a {
  text-decoration: none;
  font-weight: 500;
  color: #053b6b;
  transition: color 0.25s ease;
}

/* Light mode hover (blue-ish) */
.nav-item a:hover {
  color: #2b75ff;
}

/* Dark mode text */
body.dark .nav-item a {
  color: #eee;
}

/* Dark mode hover (orange-ish) */
body.dark .nav-item a:hover {
  color: #ff9800;
}

/* === THEME TOGGLE ON RIGHT === */
.theme-toggle {
  position: absolute;
  right: 1rem;
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
}

.theme-toggle input {
  display: none;
}

.toggle-slider {
  width: 36px;
  height: 18px;
  background: #ccc;
  border-radius: 18px;
  position: relative;
  transition: background 0.3s ease;
}

.toggle-slider::before {
  content: "";
  width: 16px;
  height: 16px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 1px;
  left: 1px;
  transition: transform 0.3s ease;
}

#toggle-theme:checked + .toggle-slider {
  background: #ff9800;
}

#toggle-theme:checked + .toggle-slider::before {
  transform: translateX(18px);
}

.hamburger {
    display: none;
    font-size: 22px;
    background: none;
    border: none;
    color: #053b6b;
    cursor: pointer;
}

body.dark .hamburger {
    color: #eee;
}

/* === MOBILE MENU === */
@media (max-width: 768px) {

  .hamburger {
    display: block;
  }
}


  /*****************************************/

/* 6. TOP PLAYER / STATS boxes */
.player-box,
.stat-box {
    background: var(--table-bg);
    border: 1px solid var(--table-border);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    width: 180px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.player-rank {
    font-weight: bold;
    font-size: 14px;
    color: var(--text-color);
    margin-bottom: 5px;
}

.player-box h3,
.stat-box h3 {
    margin: 0;
    font-size: 16px;
    color: var(--text-color);
}

.player-box p,
.stat-box p {
    margin: 5px 0 0;
    font-size: 15px;
    color: var(--text-color);
}

#top-players {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

#bottom-totals {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

/* 7. Card */
.card {
    background: var(--table-bg);
    border: 1px solid var(--table-border);
    border-radius: 10px;
    padding: 14px;
    margin: 14px auto;
    text-align: center;
    box-shadow: 0 4px 18px rgba(11, 20, 40, 0.04);
    max-width: 100%;
    overflow: visible;
}

/* 8. Diff boxes */
.cell-value {
  font-weight: 600;
  font-size: 13px;
}

.cell-diff {
  margin-top: 2px;
  font-size: 12px;
  padding: 1px 4px;
  border-radius: 4px;
  color: white;
}

.cell-diff.positive {
  background: #4caf50;
}

.cell-diff.negative {
  background: #f44336;
}

.cell-progress {
  width: 80%;
  height: 6px;
  background: rgba(0,0,0,0.08);
  border-radius: 4px;
  margin-top: 3px;
}

body.dark .cell-progress {
  background: rgba(255,255,255,0.08);
}

.cell-progress-bar {
  height: 100%;
  border-radius: 4px;
}

/* 9. TABLE: container, sticky header, scroll */
.table-container {
    max-height: 50vh;
    overflow-y: auto;
    width: 100%;
    border: 1px solid var(--table-border);
}

.table-container table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 600px;
}

.table-container th,
.table-container td {
    padding: 8px 10px;
    text-align: center;
    vertical-align: middle;
}

.table-container td {
    border: 1px solid var(--table-border);
}

.table-container thead th {
    position: sticky;
    top: 0;
    background: var(--table-bg);
    z-index: 10;
}

.table-container tbody tr:hover {
    background-color: var(--row-hover-bg);
    transition: background-color 0.15s ease;
}

.table-container tbody tr:nth-child(odd) {
  background-color: var(--table-stripe-odd);
}

.table-container tbody tr:nth-child(even) {
  background-color: var(--table-stripe-even);
}

/* CUSTOM SCROLLBARS */
.table-container::-webkit-scrollbar {
    width: 10px;
}

.table-container::-webkit-scrollbar-track {
    background: var(--accent);
    border-radius: 8px;
}

.table-container::-webkit-scrollbar-thumb {
    background: var(--scrollbar-bg);
    border-radius: 8px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.45);
}

body.dark .table-container::-webkit-scrollbar-track {
    background: #2a2a2a;
}

body.dark .table-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
}

body.dark .table-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.35);
}

/* Firefox */
.table-container {
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar-bg) var(--accent);
}

body.dark .table-container {
    scrollbar-color: rgba(255, 255, 255, 0.25) #2a2a2a;
}

/* Fixed widths for 18 columns */
.table-container th:nth-child(1) {
    width: 50px;
}

/* Index column */
.table-container th:nth-child(2) {
    width: 150px;
}

/* Column 1 */
.table-container th:nth-child(3) {
    width: 200px;
}

/* Column 2 */
.table-container th:nth-child(4) {
    width: 120px;
}

/* Column 3 */
.table-container th:nth-child(5) {
    width: 120px;
}

/* Column 4 */
.table-container th:nth-child(6) {
    width: 120px;
}

/* Column 5 */
.table-container th:nth-child(7) {
    width: 120px;
}

/* Column 6 */
.table-container th:nth-child(8) {
    width: 120px;
}

/* Column 7 */
.table-container th:nth-child(9) {
    width: 120px;
}

/* Column 8 */
.table-container th:nth-child(10) {
    width: 120px;
}

/* Column 9 */
.table-container th:nth-child(11) {
    width: 120px;
}

/* Column 10 */
.table-container th:nth-child(12) {
    width: 180px;
}

/* Column 11 */
.table-container th:nth-child(13) {
    width: 180px;
}

/* Column 12 */
.table-container th:nth-child(14) {
    width: 120px;
}

/* Column 13 */
.table-container th:nth-child(15) {
    width: 220px;
}

/* Column 14 */
.table-container th:nth-child(16) {
    width: 120px;
}

/* Column 15 */
.table-container th:nth-child(17) {
    width: 120px;
}

/* Column 16 */
.table-container th:nth-child(18) {
    width: 50px;
}

/* Sorting arrows on table headers */
th.dt-sortable {
    position: relative;
    padding-right: 16px;
}

th .sort-icons {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    line-height: 10px;
    display: flex;
    flex-direction: column;
    opacity: 0.45;
}

th.sorted-asc .sort-icons {
    opacity: 1;
}

th.sorted-desc .sort-icons {
    opacity: 1;
}

th.sorted-asc .sort-icons .up {
    color: var(--chart-line);
    font-weight: bold;
}

th.sorted-desc .sort-icons .down {
    color: var(--chart-line);
    font-weight: bold;
}

/* 10. Controls (search, size, info)*/
.dt-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
}

.dt-controls .dt-search {
    margin-left: auto;
}

.bottom-table-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 8px;
}

.bottom-table-row .dt-info {
    font-size: 14px;
}

.dt-controls input.dt-search {
    width: 200px;
    max-width: 100%;
    padding: 9px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: transparent;
    color: #333;
    font-size: 14px;
}

.dt-controls input.dt-search::placeholder {
    color: var(--text-color);
    opacity: 0.8;
}

body.dark .dt-controls input.dt-search {
    background: transparent;
    color: #eee;
    border: 1px solid #666;
}

.dt-controls select.dt-size,.source-select {
    padding: 6px;
    border-radius: 6px;
    background: var(--table-bg);
    color: inherit;
}

/* Pagination */
.dt-pager {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    margin: 10px 0;
}

.dt-pager button {
    background: var(--accent);
    color: var(--text-color);
    border: 1px solid var(--table-border);
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 13px;
}

.dt-pager button.active {
    background: rgba(0, 123, 255, 0.25);
    font-weight: bold;
}

.dt-pager button:hover {
    background: rgba(0, 123, 255, 0.15);
}

.dt-pager span.ell {
    padding: 0 8px;
    color: var(--text-color);
}

/* charts spacing */
.charts-container canvas {
    margin-top: 18px;
    margin-bottom: 18px;
}

/* 11. LOADING SPINNER */
#loading-overlay {
    display: none;
    height: 40%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text-color);
    font-size: 18px;
}

.spinner {
    border: 6px solid var(--table-border);
    border-top: 6px solid var(--chart-line);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 12px;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}
/* Responsive adjustments */
@media (max-width: 991px) {


    .dt-controls input.dt-search {
        width: 100%;
        max-width: 420px;
    }

    .table-container table {
        min-width: 520px;
    }

    .bottom-table-row {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 10px;
    }

    .dt-info {
        text-align: center;
    }

    .dt-pager {
        justify-content: center;
    }

    #top-players,
    #bottom-totals {
        flex-direction: column;
        align-items: center;
    }

    .player-box,
    .stat-box {
        width: 100%;
        max-width: 260px;
    }
}

@media (max-width: 480px) {
    .dt-controls {
        gap: 8px;
    }

    .dt-controls input.dt-search {
        padding: 6px;
    }
}

@media (max-width: 1366px) {


    .dt-controls input.dt-search {
        width: 100%;
        max-width: 420px;
    }

    .table-container table {
        min-width: 520px;
    }

    .bottom-table-row {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 10px;
    }

    .dt-info {
        text-align: center;
    }

    .dt-pager {
        justify-content: center;
    }

    #top-players,
    #bottom-totals {
        display: flex;
        justify-content: center;
        margin-left: 3px;
        margin-right: 3px;
    }

    .player-box,
    .stat-box {
        width: 100%;
        max-width: 260px;
    }
    .card {
        margin-left: 3px;
        margin-right: 3px;
    }
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal.hidden {
  display: none;
}

.modal-content {
  background: var(--table-bg);
  padding: 20px;
  border-radius: 12px;
  width: 80%;
  max-width: 900px;
  box-shadow: 0 0 20px rgba(0,0,0,0.4);
}

.close-btn {
  float: right;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-color);
}

.chart-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 10px;
}

.chart-buttons button {
  padding: 8px 14px;
  border-radius: 6px;
  border: 1px solid var(--table-border);
  cursor: pointer;
  background: #007bff;
  color: var(--text-color);
}
.gov-link {
  position: relative;
  cursor: pointer;
  color: var(--text-color);
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.gov-icon {
  opacity: 0;
  transform: translateX(-3px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  display: inline-flex;
  align-items: center;
}

.gov-link:hover .gov-icon {
  opacity: 1;
  transform: translateX(0);
}

#modal-title {
  text-align: center;
  width: 100%;
  margin: 0 auto 12px auto;
  font-weight: bold;
}
</style>
</head>
<body>

  <header class="header" id="header">
    <nav class="nav-container">
      <button class="hamburger" id="hamburger" aria-label="Menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
        </svg>
      </button>
      
      <div class="nav-menu" id="nav-menu">
        <ul class="nav-links" id="nav-links">
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
          <li class="nav-item"><a class="nav-link" href="">Test</a></li>
        </ul>
        
      </div>
      
      <label class="theme-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun" viewBox="0 0 16 16">
          <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6m0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/>
        </svg>
        <input type="checkbox" id="toggle-theme">
        <span class="toggle-slider"></span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon" viewBox="0 0 16 16">
          <path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278M4.858 1.311A7.27 7.27 0 0 0 1.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.32 7.32 0 0 0 5.205-2.162q-.506.063-1.029.063c-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286"/>
        </svg>
      </label>
    </nav>
  </header>

<div class="row">
  <div class="column side">Column</div>
  <div class="column middle">
      <div id="loading-overlay">
        <div class="spinner"></div>
        Loading data...
      </div>

      <div id="top-players"></div>
      <div id="bottom-totals"></div>

      <div class="card">
        <div class="dt-controls">

          <label for="dt-size">Rows per page</label>
          <select class="dt-size">
            <option value="20">20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <label for="source-select">Source</label>
          <select id="source-select" class="source-select">
            <option>Select source</option>
          </select>

          <input class="dt-search" placeholder="Search…" />
        </div>

        <div class="table-container">
          <table id="data-table" class="dataTable"></table>
        </div>

        <div class="bottom-table-row">
          <div class="dt-info"></div>
          <div class="dt-pager"></div>
        </div>
      </div>
    
  </div>
  <div class="column side">Column</div>
</div>

<div class="footer">
  <p>Footer</p>
</div>


  <div id="chart-modal" class="modal hidden">
    <div class="modal-content">
      <button id="close-modal" class="close-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
          <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
        </svg>
      </button>

      <h2 id="modal-title"></h2>

      <canvas id="modal-chart"></canvas>

      <div class="chart-buttons">
        <button data-col="16">Power Diff</button>
        <button data-col="3">T4 Kills</button>
        <button data-col="4">T5 Kills</button>
        <button data-col="5">Kill Points</button>
        <button data-col="6">Deads</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
<script>
/* CONFIGURATION */
const CONFIG = {
  sources: [
    {
      id: "main",
      name: "KD2247",
      url: "https://docs.google.com/spreadsheets/d/1bP7LMwUuN3gjIEWKo0QCStKmrvIzn9rrYedoaUJh5zg/edit?usp=sharing",
    },
    {
      id: "backup",
      name: "KD2552",
      url: "https://docs.google.com/spreadsheets/d/1HS6wcMWCzLR4PVhYJA_8rFzUuqaYvwUilD2zffq9YNE/edit?usp=sharing",
    },
  ],
};

const API_KEY = "AIzaSyAPP27INsgILZBAigyOm-g31djFgYlU7VY";

/* COLUMNS / BEHAVIOR CONFIG */
const SELECTED_COLS = [0, 1, 2, 12, 13, 14, 15, 8, 9];
const SHORT_NUMBER_COLS = [2, 12, 13, 14, 15, 8];
const PROGRESS_COLS = [2, 12, 13, 14, 15];
const DIFF_COLS = [2, 12, 13, 14, 15];

/* STATE */
let googleSheetId = null;
let googleSheetNames = [];
let googleSheetsData = {};
let currentSource = null;
let sourcesCache = {};
let diffsCache = {};
let modalChart = null;
let selectedGovernorId = null;
let currentMetric = 16; // default metric for modal chart
let _documentClickListenerAdded = false;

/* Simple query helper */
const qs = (sel) => document.querySelector(sel);

/* -------------------------
   UTILS
   ------------------------- */
function formatNumber(num) {
  const n = Number(num);
  return isNaN(n) ? "" : n.toLocaleString("en-US");
}

function cleanRows(rows = []) {
  return rows.filter(
    (r) =>
      Array.isArray(r) && r.some((c) => c !== undefined && `${c}`.trim() !== "")
  );
}

function extractSheetId(url) {
  const match = (url || "").match(/\/d\/([a-zA-Z0-9-_]+)/);
  return match ? match[1] : null;
}

/* -------------------------
   DIFF CALCULATIONS (cached)
   ------------------------- */
function computeDiffs() {
  diffsCache = {};

  const lastSheet = googleSheetNames.at(-1);
  const rows = (googleSheetsData[lastSheet] || []).slice(1);

  rows.forEach((row) => {
    const id = String(row[0] ?? "").trim();
    if (!id) return;

    // Keep the original mapping but coerce to numbers with fallback 0
    diffsCache[id] = {
      3: Number(row[3]) || 0,
      4: Number(row[4]) || 0,
      5: Number(row[5]) || 0,
      6: Number(row[6]) || 0,
      2: Number(row[16]) || 0, // original used col 16 for Power diff
      12: Number(row[4]) || 0,
      13: Number(row[5]) || 0,
      14: Number(row[3]) || 0,
      15: Number(row[6]) || 0,
    };
  });
}

function getDiff(id, col) {
  return diffsCache[id]?.[col] ?? 0;
}

/* -------------------------
   GOVERNOR / NAME HELPERS
   ------------------------- */
function getGovernorName(id) {
  const sheet = googleSheetNames.at(-1);
  const rows = googleSheetsData[sheet];
  if (!rows) return id;
  const found = rows.find((r) => `${r[0]}` === `${id}`);
  return found ? found[1] : id;
}

/* -------------------------
   CHARTS (modal)
   ------------------------- */
function getChartStyles() {
  const css = (v) => getComputedStyle(document.body).getPropertyValue(v).trim();
  const line = css("--chart-line") || "#007bff";
  return {
    text: css("--chart-text") || "#333",
    grid: css("--chart-grid") || "rgba(0,0,0,0.1)",
    line,
    dataset: {
      borderColor: line,
      backgroundColor: line + "33",
      tension: 0.3,
    },
  };
}

function openChartModal(governorId) {
  selectedGovernorId = governorId;
  const modal = qs("#chart-modal");
  const title = qs("#modal-title");
  const name = getGovernorName(governorId);
  title.textContent = `${name} (ID: ${governorId})`;

  modal.classList.remove("hidden");

  if (modalChart) {
    modalChart.destroy();
    modalChart = null;
  }

  const ctx = qs("#modal-chart").getContext("2d");
  modalChart = new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [{ label: "", data: [] }] },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: getChartStyles().text } } },
      scales: {
        x: { ticks: { color: getChartStyles().text } },
        y: { ticks: { color: getChartStyles().text } },
      },
    },
  });

  updateModalChart(currentMetric);
}

function updateModalChart(colIndex) {
  if (!modalChart) return;
  currentMetric = colIndex;

  const sheets = googleSheetNames || [];
  const values = sheets.map((sheet) => {
    const row = (googleSheetsData[sheet] || [])
      .slice(1)
      .find((r) => `${r[0]}` === `${selectedGovernorId}`);
    return row ? Number(row[colIndex] || 0) : 0;
  });

  modalChart.data.labels = sheets;
  modalChart.data.datasets[0].data = values;

  const labelMap = {
    16: "Power Diff",
    3: "T4 Kills",
    4: "T5 Kills",
    5: "Kill Points",
    6: "Deads",
  };
  modalChart.data.datasets[0].label = labelMap[colIndex] || `Col ${colIndex}`;

  modalChart.update();
}

/* -------------------------
   TABLE / UI RENDERING
   ------------------------- */
function renderTable(headers, rawRows) {
  let rows = cleanRows(rawRows);
  // filter out rows where col 11 (index 11) equals "YES"
  rows = rows.filter(
    (r) =>
      String(r[11] ?? "")
        .trim()
        .toUpperCase() !== "YES"
  );

  computeDiffs();

  // sort by power (col 8) desc
  rows.sort((a, b) => (Number(b[8]) || 0) - (Number(a[8]) || 0));

  renderTopPlayers(rows.slice(0, 3));
  buildTable(headers, rows);
  renderTotals(rows);
}

function renderTopPlayers(players) {
  const box = qs("#top-players");
  if (!box) return;
  box.innerHTML = "";

  players.forEach((p, i) => {
    const el = document.createElement("div");
    el.className = "player-box";
    el.innerHTML = `
      <div class="player-rank">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trophy-fill" viewBox="0 0 16 16">
          <path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5q0 .807-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33 33 0 0 1 2.5.5m.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935m10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935"/>
        </svg>
        TOP${i + 1}
      </div>
      <h3>${escapeHtml(p[1] ?? "")}</h3>
      <p>ID: ${escapeHtml(p[0] ?? "")}</p>
    `;
    box.appendChild(el);
  });
}

function buildTable(headers = [], rows = []) {
  const table = qs("#data-table");
  if (!table) return;

  // clear
  table.innerHTML = "";

  // header
  const thead = document.createElement("thead");
  const trHead = document.createElement("tr");

  const indexTh = document.createElement("th");
  indexTh.textContent = "#";
  trHead.appendChild(indexTh);

  SELECTED_COLS.forEach((i) => {
    const th = document.createElement("th");
    th.classList.add("dt-sortable");

    const label = document.createElement("span");
    label.textContent = headers[i] || "";

    const icons = document.createElement("span");
    icons.className = "sort-icons";
    icons.innerHTML = `<span class="up">▲</span><span class="down">▼</span>`;

    th.appendChild(label);
    th.appendChild(icons);
    trHead.appendChild(th);
  });

  thead.appendChild(trHead);

  // body
  const tbody = document.createElement("tbody");
  const maxValues = getMaxValues(rows);

  rows.forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.id = row[0];

    const idxCell = document.createElement("td");
    idxCell.textContent = idx + 1;
    tr.appendChild(idxCell);

    SELECTED_COLS.forEach((col) => {
      tr.appendChild(makeCell(row, col, maxValues[col]));
    });

    tbody.appendChild(tr);
  });

  table.appendChild(thead);
  table.appendChild(tbody);

  activateDataTable();
  addRowClickEventsOnce();
}

function getMaxValues(rows) {
  const max = {};
  SELECTED_COLS.forEach((c) => {
    max[c] = Math.max(...rows.map((r) => Number(r[c]) || 0), 0);
  });
  return max;
}

function makeCell(row, col, maxVal = 0) {
  const td = document.createElement("td");
  const id = row[0];
  const raw = row[col];
  const numeric = Number(raw);

  td.classList.add("cell");

  // sortable value
  td.dataset.value = !isNaN(numeric) ? numeric : raw ?? "";

  // value area
  const valueDiv = document.createElement("div");
  valueDiv.className = "cell-value";

  if (col === 0) {
    // governor ID clickable
    valueDiv.innerHTML = `
      <span class="gov-link" data-id="${escapeHtml(raw ?? "")}">
        ${escapeHtml(raw ?? "")}
        <span class="gov-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
          </svg>
        </span>
      </span>`;
  } else {
    valueDiv.textContent = SHORT_NUMBER_COLS.includes(col)
      ? formatNumber(numeric)
      : raw ?? "";
  }

  td.appendChild(valueDiv);

  // diff
  if (DIFF_COLS.includes(col)) {
    const diff = getDiff(id, col);
    if (diff !== 0) {
      const diffDiv = document.createElement("div");
      diffDiv.className = `cell-diff ${diff > 0 ? "positive" : "negative"}`;
      diffDiv.textContent = `${diff > 0 ? "+" : ""}${formatNumber(diff)}`;
      td.appendChild(diffDiv);
    }
  }

  // progress bar
  if (PROGRESS_COLS.includes(col)) {
    const progress = document.createElement("div");
    progress.className = "cell-progress";

    const bar = document.createElement("div");
    bar.className = "cell-progress-bar";

    const colors = {
      12: "#00bcd4", // T4
      13: "#ffc107", // T5
      14: "#e91e63", // KP
      15: "#f44336", // Deads
      8: "#4caf50", // Power
    };

    bar.style.background = colors[col] || "#2196f3";
    bar.style.width =
      maxVal > 0 ? `${((Number(row[col]) || 0) / maxVal) * 100}%` : "0%";

    progress.appendChild(bar);
    td.appendChild(progress);
  }

  return td;
}

/* -------------------------
   SIMPLE DATATABLE: search / sort / pagination
   ------------------------- */
function activateDataTable() {
  const table = qs("#data-table");
  if (!table) return;

  const tbody = table.querySelector("tbody");
  if (!tbody) return;

  // snapshot rows
  const rows = [...tbody.querySelectorAll("tr")];

  // store state on the table element
  const state = table.__dtState || {
    filteredRows: rows.slice(),
    page: 1,
    pageSize: 20,
    currentSort: { col: null, dir: 1 },
  };
  table.__dtState = state;

  // ui references
  const controlBar = qs(".dt-controls");
  const searchInput = controlBar?.querySelector("input.dt-search");
  const sizeSelect = controlBar?.querySelector("select.dt-size");
  const infoBox = qs(".bottom-table-row .dt-info");
  const pager = qs(".bottom-table-row .dt-pager");

  if (sizeSelect) sizeSelect.value = state.pageSize;
  if (searchInput) searchInput.value = "";

  // SEARCH
  if (searchInput) {
    searchInput.oninput = () => {
      const q = searchInput.value.toLowerCase().trim();
      state.filteredRows = rows.filter((r) =>
        r.textContent.toLowerCase().includes(q)
      );
      state.page = 1;
      renderPage();
    };
  }

  // PAGE SIZE
  if (sizeSelect) {
    sizeSelect.onchange = () => {
      state.pageSize = Number(sizeSelect.value) || 20;
      state.page = 1;
      renderPage();
    };
  }

  // SORTING
  table.querySelectorAll("thead th").forEach((th, colIndex) => {
    if (colIndex === 0) return; // skip index column
    th.style.cursor = "pointer";
    th.onclick = () => {
      const sort = state.currentSort;

      // tri-state: null means no sort
      if (sort.col !== colIndex) {
        sort.col = colIndex;
        sort.dir = 1; // ASC
      } else if (sort.dir === 1) {
        sort.dir = -1; // DESC
      } else {
        sort.col = null;
        sort.dir = 1;
      }

      updateSortIcons();

      if (sort.col === null) {
        // restore order (filtered by search)
        state.filteredRows = rows.filter((r) =>
          r.textContent
            .toLowerCase()
            .includes((searchInput?.value || "").toLowerCase())
        );
      } else {
        const col = sort.col;
        const dir = sort.dir;
        state.filteredRows.sort((a, b) => {
          const A = parseSortableValue(a.children[col].dataset.value);
          const B = parseSortableValue(b.children[col].dataset.value);

          if (!isNaN(A.num) && !isNaN(B.num)) {
            return (A.num - B.num) * dir;
          }
          if (!isNaN(A.num) && isNaN(B.num)) return -1 * dir;
          if (isNaN(A.num) && !isNaN(B.num)) return 1 * dir;

          return A.text.localeCompare(B.text) * dir;
        });
      }

      state.page = 1;
      renderPage();
    };
  });

  function updateSortIcons() {
    table.querySelectorAll("thead th").forEach((th, idx) => {
      th.classList.remove("sorted-asc", "sorted-desc");
      if (idx === state.currentSort.col) {
        th.classList.add(
          state.currentSort.dir === 1 ? "sorted-asc" : "sorted-desc"
        );
      }
    });
  }

  function parseSortableValue(v) {
    if (v == null) return { num: NaN, text: "" };
    let s = String(v).trim();
    s = s.replace(/,/g, "");
    if (/^\d+(\.\d+)?%$/.test(s)) {
      const num = parseFloat(s.replace("%", ""));
      return { num, text: s };
    }
    const n = Number(s);
    if (!isNaN(n)) return { num: n, text: s };
    return { num: NaN, text: s.toLowerCase() };
  }

  // Pagination helpers
  function makeBtn(label, page, opts = {}) {
    const b = document.createElement("button");
    b.textContent = label;
    if (opts.disabled) b.disabled = true;
    if (opts.active) b.classList.add("active");
    b.onclick = () => {
      if (opts.disabled) return;
      state.page = page;
      renderPage();
    };
    return b;
  }

  function getCenteredPages(current, total, windowSize) {
    if (total <= windowSize) {
      return Array.from({ length: total }, (_, i) => i + 1);
    }
    const half = Math.floor(windowSize / 2);
    let start = current - half;
    let end = current + half;
    if (start < 2) {
      start = 2;
      end = windowSize;
    }
    if (end > total - 1) {
      end = total - 1;
      start = total - windowSize + 1;
    }
    const pages = [];
    for (let i = start; i <= end; i++) pages.push(i);
    return pages;
  }

  function renderPager(totalPages) {
    pager.innerHTML = "";
    pager.appendChild(makeBtn("<<", 1, { disabled: state.page === 1 }));
    pager.appendChild(
      makeBtn("<", Math.max(1, state.page - 1), { disabled: state.page === 1 })
    );

    const current = state.page;
    const windowSize = 3;

    pager.appendChild(makeBtn("1", 1, { active: current === 1 }));

    if (current > Math.ceil(windowSize / 2) + 1) {
      const ell = document.createElement("span");
      ell.textContent = "...";
      ell.className = "ell";
      pager.appendChild(ell);
    }

    const pages = getCenteredPages(current, totalPages, windowSize);
    pages.forEach((p) => {
      if (p !== 1 && p !== totalPages) {
        pager.appendChild(makeBtn(p, p, { active: current === p }));
      }
    });

    if (current < totalPages - Math.ceil(windowSize / 2)) {
      const ell = document.createElement("span");
      ell.textContent = "...";
      ell.className = "ell";
      pager.appendChild(ell);
    }

    if (totalPages > 1) {
      pager.appendChild(
        makeBtn(totalPages, totalPages, { active: current === totalPages })
      );
    }

    pager.appendChild(
      makeBtn(">", Math.min(totalPages, current + 1), {
        disabled: current === totalPages,
      })
    );
    pager.appendChild(
      makeBtn(">>", totalPages, { disabled: current === totalPages })
    );
  }

  function renderPage() {
    const prevSelectedId = tbody.querySelector(".selected")?.dataset?.id;
    tbody.innerHTML = "";

    const total = state.filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
    if (state.page > totalPages) state.page = totalPages;

    const start = (state.page - 1) * state.pageSize;
    const end = Math.min(start + state.pageSize, total);

    const slice = state.filteredRows.slice(start, end);
    slice.forEach((r) => tbody.appendChild(r));

    if (prevSelectedId) {
      const row = tbody.querySelector(`tr[data-id="${prevSelectedId}"]`);
      if (row) row.classList.add("selected");
    }

    infoBox.textContent =
      total === 0 ? "No entries" : `Showing ${start + 1}–${end} of ${total}`;
    renderPager(totalPages);
  }

  state.filteredRows = rows.slice();
  renderPage();
}

/* -------------------------
   CLICK EVENTS
   - single document-level listener used for gov-link clicks
   ------------------------- */
function addRowClickEventsOnce() {
  if (_documentClickListenerAdded) return;
  _documentClickListenerAdded = true;

  document.addEventListener("click", (e) => {
    // looks for element with data-id (gov link)
    const link = e.target.closest(".gov-link");
    if (!link) return;
    
    const id = link.dataset?.id;
    if (!id) return;
    
    openChartModal(id);
  });
}

/* -------------------------
   TOTALS (bottom)
   ------------------------- */
function renderTotals(rows = []) {
  const container = qs("#bottom-totals");
  if (!container) return;
  container.innerHTML = "";

  const defs = [
    { label: "Total T4 kills", col: 4 },
    { label: "Total T5 kills", col: 5 },
    { label: "Total Deads", col: 6 },
    { label: "Total KP", col: 3 },
  ];

  defs.forEach(({ label, col }) => {
    const sum = rows.reduce(
      (acc, r) => acc + (diffsCache[r[0]]?.[col] || 0),
      0
    );
    const box = document.createElement("div");
    box.className = "stat-box";
    box.innerHTML = `<h3>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sticky-fill" viewBox="0 0 16 16">
        <path d="M2.5 1A1.5 1.5 0 0 0 1 2.5v11A1.5 1.5 0 0 0 2.5 15h6.086a1.5 1.5 0 0 0 1.06-.44l4.915-4.914A1.5 1.5 0 0 0 15 8.586V2.5A1.5 1.5 0 0 0 13.5 1zm6 8.5a1 1 0 0 1 1-1h4.396a.25.25 0 0 1 .177.427l-5.146 5.146a.25.25 0 0 1-.427-.177z"/>
      </svg>
      ${escapeHtml(label)}</h3><p>${Number(sum).toLocaleString()}</p>`;
    container.appendChild(box);
  });
}

/* -------------------------
   GOOGLE SHEETS LOADING (per-source)
   ------------------------- */
async function loadSource(sourceId) {
  const select = qs("#source-select");
  if (select) select.disabled = true;

  const source = CONFIG.sources.find((s) => s.id === sourceId);
  if (!source) {
    if (select) select.disabled = false;
    return;
  }

  qs("#loading-overlay").style.display = "flex";

  // if cached, just enable controls and return
  if (sourcesCache[sourceId]) {
    qs("#loading-overlay").style.display = "none";
    if (select) select.disabled = false;
    return;
  }

  const sheetId = extractSheetId(source.url);
  if (!sheetId) {
    qs("#loading-overlay").style.display = "none";
    if (select) select.disabled = false;
    throw new Error("Invalid Google Sheets URL for source: " + sourceId);
  }

  const metaRes = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?key=${API_KEY}`
  );
  const meta = await metaRes.json();
  const sheetNames = (meta.sheets || []).map((s) => s.properties.title);
  const sheetData = {};

  await Promise.all(
    sheetNames.map(async (name) => {
      const r = await fetch(
        `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(
          name
        )}?key=${API_KEY}`
      );
      const json = await r.json();
      sheetData[name] = json.values || [];
    })
  );

  sourcesCache[sourceId] = {
    sheetNames,
    sheetData,
  };

  qs("#loading-overlay").style.display = "none";
  if (select) select.disabled = false;
}

function applySourceData(sourceId) {
  const cached = sourcesCache[sourceId];
  if (!cached) return;

  googleSheetNames = cached.sheetNames;
  googleSheetsData = cached.sheetData;

  const lastSheet = googleSheetNames.at(-1);
  const headers = (googleSheetsData[lastSheet] || [])[0] || [];
  const rows = (googleSheetsData[lastSheet] || []).slice(1);

  renderTable(headers, rows);

  // update modal if open
  if (selectedGovernorId) {
    updateModalChart(currentMetric);
  }
}

/* -------------------------
   BOOTSTRAP / EVENT BINDING
   ------------------------- */
document.addEventListener("DOMContentLoaded", async () => {
  // UI refs
  const sourceSelect = qs("#source-select");
  const loadingOverlay = qs("#loading-overlay");
  const closeModalBtn = qs("#close-modal");
  const chartButtons = qs(".chart-buttons");

  // populate source selector
  if (sourceSelect) {
    CONFIG.sources.forEach((src) => {
      const opt = document.createElement("option");
      opt.value = src.id;
      opt.textContent = src.name;
      sourceSelect.appendChild(opt);
    });

    sourceSelect.addEventListener("change", async () => {
      const sourceId = sourceSelect.value;
      selectedGovernorId = null;

      if (loadingOverlay) loadingOverlay.style.display = "flex";

      await loadSource(sourceId);
      applySourceData(sourceId);

      const card = qs(".card");
      if (card) card.style.display = "block";
      if (loadingOverlay) loadingOverlay.style.display = "none";
    });
  }

  // Modal close
  if (closeModalBtn) {
    closeModalBtn.addEventListener("click", () =>
      qs("#chart-modal")?.classList.add("hidden")
    );
  }

  // Chart buttons (switch metric)
  if (chartButtons) {
    chartButtons.addEventListener("click", (e) => {
      const col = Number(e.target.dataset?.col);
      if (!isNaN(col)) updateModalChart(col);
    });
  }

  // Hide loading initially
  if (loadingOverlay) loadingOverlay.style.display = "none";
});

/* -------------------------
   SMALL SAFETY HELPERS
   ------------------------- */
function escapeHtml(str) {
  if (str == null) return "";
  return String(str).replace(/[&<>"'`=\/]/g, function (s) {
    return {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
      "/": "&#x2F;",
      "`": "&#x60;",
      "=": "&#x3D;",
    }[s];
  });
}


  
    /* -------------------------
   THEME HANDLING
------------------------- */

function setTheme(mode) {
  document.body.classList.remove("dark", "light");
  if (mode === "dark") document.body.classList.add("dark");
  if (mode === "light") document.body.classList.add("light");
  localStorage.setItem("theme", mode);
}

function initializeTheme(toggleEl) {
  const saved = localStorage.getItem("theme");

  if (saved === "dark") {
    setTheme("dark");
    toggleEl.checked = true;
    return;
  }

  if (saved === "light") {
    setTheme("light");
    toggleEl.checked = false;
    return;
  }

  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  setTheme(prefersDark ? "dark" : "light");
  toggleEl.checked = prefersDark;
}

const themeToggle = document.getElementById("toggle-theme");
initializeTheme(themeToggle);

themeToggle.addEventListener("change", (e) => {
  setTheme(e.target.checked ? "dark" : "light");
});

/* -------------------------
   HAMBURGER MENU HANDLING
------------------------- */
const hamburger = document.getElementById("hamburger");
const navLinks = document.getElementById("nav-links");

hamburger.addEventListener("click", () => {
  navLinks.classList.toggle("show");
});

</script>
</body>
</html>
