<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excel Merge Tool</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: #f6f8fa;
      --card: #ffffff;
      --accent: #0b74d1;
      --muted: #586069;
    }
    *{box-sizing:border-box}
    
    body {
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #111827;
    }

    .container { 
      max-width:40%; 
      margin:24px auto; 
      padding:16px; 
    }

    .card {
      background: var(--card);
      padding:24px;
      border-radius:10px;
      box-shadow: 0 4px 18px rgba(11,20,40,0.04);
      margin:14px 0;
      text-align:center;
    }

    .row {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    input[type="file"] { padding:6px; }
    select, button {
      padding:8px 12px; 
      border-radius:8px;
      border:1px solid #e2e8f0;
      min-width:140px;
      cursor:pointer;
    }

    button.primary {  
      background: var(--accent); 
      color:white; 
      box-shadow: 0 6px 14px rgba(11,74,209,0.12); 
      border:none;
    }

    ::file-selector-button {
      padding:4px 6px; 
      border-radius:8px; 
      border:none; 
      cursor:pointer; 
      background:#e6eef9; 
      color:#053b6b;
    }

    progress {
      width: 80%;
      height: 14px;
      margin-top: 10px;
    }

    /* Dark mode */
    body.dark { background:#111; color:#f1f1f1; }
    body.dark .card { background:#1a1a1a; }
    body.dark select, body.dark input, body.dark button { background:#222; color:#eee; border:1px solid #444; }
    body.dark button.primary { background:#0b74d1; color:white; }

    /* Navbar simplified */
    .navbar {
      position: sticky;
      top: 8px;
      z-index: 999;
      width: 75%;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      padding: 10px 24px;
      transition: all 0.3s ease;
    }
    .nav-container { display:flex; justify-content:space-between; align-items:center; }
    .nav-links { flex:1; display:flex; justify-content:center; gap:28px; }
    .nav-links a { text-decoration:none; font-weight:500; color:#053b6b; }
    .nav-links a:hover { color:var(--accent); }

    .theme-toggle { display:flex; align-items:center; gap:6px; cursor:pointer; }
    .theme-toggle input{display:none}
    .toggle-slider {
      position: relative; width:50px; height:24px;
      background-color:#ccc; border-radius:12px;
      transition:background-color .3s;
    }
    .toggle-slider::before {
      content:""; position:absolute; top:3px; left:3px;
      width:18px; height:18px; background:white; border-radius:50%;
      transition:transform .3s;
    }
    .theme-toggle input:checked + .toggle-slider {
      background-color:#ff9800;
    }
    .theme-toggle input:checked + .toggle-slider::before {
      transform:translateX(26px);
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="nav-container">
      <div class="nav-links">
        <a href="index3.html">Merge</a>
        <a href="index4.html">DKP Calculator</a>
        <a href="index2.html">Compare</a>
      </div>
      <label class="theme-toggle">
        ðŸŒž
        <input type="checkbox" id="toggle-theme">
        <span class="toggle-slider"></span>
        ðŸŒ™
      </label>
    </div>
  </header>

  <div class="container">
    <section class="card">
      <h2>Merge Files</h2>
      <div class="row">
        <label>File 1: <input id="merge-file1" type="file" accept=".xlsx,.xls,.csv"></label>
        <label>File 2: <input id="merge-file2" type="file" accept=".xlsx,.xls,.csv"></label>
      </div>

      <div class="row">
        <label for="idColumnSelect">Select ID Column:</label>
        <select id="idColumnSelect"></select>
      </div>

      <div class="row">
        <button id="merge-btn" class="primary">ðŸ”„ Merge Files</button>
      </div>

      <progress id="merge-progress" value="0" max="100" style="display:none;"></progress>

      <div class="row">
        <button id="merge-export-xlsx">ðŸ’¾ Export XLSX</button>
        <button id="merge-export-csv">ðŸ“„ Export CSV</button>
        <button id="merge-export-json">ðŸ”£ Export JSON</button>
      </div>
      <div id="merge-results" class="muted">No merged data yet.</div>
    </section>
  </div>

  <script>
  const f1 = document.getElementById("merge-file1");
  const f2 = document.getElementById("merge-file2");
  const mergeBtn = document.getElementById("merge-btn");
  const exportXlsxBtn = document.getElementById("merge-export-xlsx");
  const exportCsvBtn = document.getElementById("merge-export-csv");
  const exportJsonBtn = document.getElementById("merge-export-json");
  const mergeResults = document.getElementById("merge-results");
  const progressBar = document.getElementById("merge-progress");
  const idSelect = document.getElementById("idColumnSelect");

  let mergedData = null;
  let file1Data = [];
  let file2Data = [];

  async function readFile(file) {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(sheet, { defval: "" });
  }

  async function populateIdSelect() {
    if (!file1Data.length || !file2Data.length) return;
    const cols1 = Object.keys(file1Data[0]);
    const cols2 = Object.keys(file2Data[0]);
    const common = cols1.filter(c => cols2.includes(c));
    idSelect.innerHTML = common.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  mergeBtn.addEventListener("click", async () => {
    const file1 = f1.files[0];
    const file2 = f2.files[0];
    if (!file1 || !file2) return alert("Please select both files first!");
    mergeResults.textContent = "Reading files...";
    progressBar.style.display = "block";
    progressBar.value = 10;

    file1Data = await readFile(file1);
    progressBar.value = 40;
    file2Data = await readFile(file2);
    progressBar.value = 60;

    await populateIdSelect();

    const idCol = idSelect.value || (Object.keys(file1Data[0])[0]);
    mergeResults.textContent = "Merging data on ID: " + idCol;

    const map = new Map();
    // Build map from File1
    for (const row of file1Data) {
      map.set(row[idCol], { ...row });
    }

    // Merge from File2 (overwriting duplicate IDs)
    for (const row of file2Data) {
      const id = row[idCol];
      if (map.has(id)) {
        // merge existing row with file2 data
        map.set(id, { ...map.get(id), ...row });
      } else {
        map.set(id, { ...row });
      }
    }

    mergedData = Array.from(map.values());
    progressBar.value = 100;
    mergeResults.textContent = `âœ… Merged ${map.size} unique rows.`;
  });

  function exportXlsx(data) {
    if (!data) return alert("No merged data to export.");
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Merged");
    XLSX.writeFile(wb, `merged_${new Date().toISOString().replace(/[:.]/g,"-")}.xlsx`);
  }

  function exportCsv(data) {
    if (!data) return alert("No merged data to export.");
    const ws = XLSX.utils.json_to_sheet(data);
    const csv = XLSX.utils.sheet_to_csv(ws);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `merged_${new Date().toISOString().replace(/[:.]/g,"-")}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportJson(data) {
    if (!data) return alert("No merged data to export.");
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `merged_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  exportXlsxBtn.addEventListener("click", () => exportXlsx(mergedData));
  exportCsvBtn.addEventListener("click", () => exportCsv(mergedData));
  exportJsonBtn.addEventListener("click", () => exportJson(mergedData));

  // --- Dark mode ---
  const toggleTheme = document.getElementById("toggle-theme");
  function applyTheme(isDark) {
    document.body.classList.toggle("dark", isDark);
    localStorage.setItem("dkp_darkmode", isDark ? "1" : "0");
    toggleTheme.checked = isDark;
  }
  toggleTheme.addEventListener("change", e => applyTheme(e.target.checked));
  applyTheme(localStorage.getItem("dkp_darkmode") === "1");
  </script>
</body>
</html>
